from aiogram import Router
from aiogram.types import Message
from aiogram.filters import Command, Filter
import re
from typing import Dict, List, Optional, Tuple, Set, Pattern
from functools import lru_cache
import logging
import traceback
from ..managers.database_manager import VideoDatabaseManager

logger = logging.getLogger(__name__)
router = Router()
db_manager = VideoDatabaseManager()

# ========== –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò ==========
DEBUG_MODE = False
MAX_AI_CREATOR_ID = 19

# –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
BASIC_COMMANDS = {
    '/start', '/help', '/stats', '/total_videos', '/total_creators', '/total_snapshots',
    '/total_reports', '/total_likes', '/total_comments', '/total_views', '/clear_cache', '/test_db',
}

# AI –∫–æ–º–∞–Ω–¥—ã –∏ –∞–ª–∏–∞—Å—ã
AI_COMMANDS_CANONICAL = {
    '/aispravka', '/analiz', '/creator', '/top3', '/rating', '/extremes', '/analizvideo',
    '/platformanalysis', '/test_ai', '/video100k', '/video50k', '/video25k',
}

AI_COMMAND_ALIASES = {
    '/aispravka': ['/aihelp', '/ai_—Å–ø—Ä–∞–≤–∫–∞', '/–∞–π—Å–ø—Ä–∞–≤–∫–∞', '/ai_help', '/–∞–π—Ö–µ–ª–ø'],
    '/analiz': ['/–∞–Ω–∞–ª–∏–∑', '/analyze', '/ai_analysis'],
    '/creator': ['/–∫—Ä–µ–∞—Ç–æ—Ä'],
    '/top3': ['/—Ç–æ–ø3', '/top', '/—Ç–æ–ø', '/analyze_top3'],
    '/rating': ['/—Ä–µ–π—Ç–∏–Ω–≥'],
    '/extremes': ['/—ç–∫—Å—Ç—Ä–µ–º—É–º—ã', '/maxmin', '/–º–∞–∫—Å–º–∏–Ω', '/analyze_extremes'],
    '/analizvideo': ['/analyze_videos'],
    '/platformanalysis': ['/obshiyanaliz', '/analizplatformy', '/–æ–±—â–∏–π_–∞–Ω–∞–ª–∏–∑', '/fullanalysis', '/analyzeall'],
    '/test_ai': ['/proverkaai', '/–ø—Ä–æ–≤–µ—Ä–∫–∞_ai', '/testai'],
    '/video100k': ['/video_100000', '/–≤–∏–¥–µ–æ100–∫', '/–≤–∏–¥–µ–æ_100000', '/–≤–∏–¥–µ–æ100–∫'],
    '/video50k': ['/video_50000', '/–≤–∏–¥–µ–æ50–∫', '/–≤–∏–¥–µ–æ_50000'],
    '/video25k': ['/video_25000', '/–≤–∏–¥–µ–æ25–∫', '/–≤–∏–¥–µ–æ_25000'],
}

ALL_AI_COMMANDS = set(AI_COMMANDS_CANONICAL)
for aliases in AI_COMMAND_ALIASES.values():
    ALL_AI_COMMANDS.update(aliases)

# ========== üî• –í–ê–†–ò–ê–ù–¢ 3: AI –§–ò–õ–¨–¢–† –í –ë–ê–ó–û–í–û–ú –•–≠–ù–î–õ–ï–†–ï ==========

# –ö–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è AI —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
AI_PATTERNS = [
    # –ö—Ä–µ–∞—Ç–æ—Ä —Å —Ü–∏—Ñ—Ä–æ–π
    re.compile(r'^(?:–∫—Ä–µ–∞—Ç–æ—Ä|–∞–Ω–∞–ª–∏–∑|–ø–æ–∫–∞–∂–∏|–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π|—Å–æ–∑–¥–∞—Ç–µ–ª—å|–∞–≤—Ç–æ—Ä)\s+\d+', re.IGNORECASE),
    # –¢–æ–ø –∫–æ–º–∞–Ω–¥—ã
    re.compile(r'^—Ç–æ–ø\s+(?:–≤–∏–¥–µ–æ|—Ä–æ–ª–∏–∫–æ–≤|–ø—Ä–æ—Å–º–æ—Ç—Ä|–ª–∞–π–∫|–∫–æ–º–º–µ–Ω—Ç–∞—Ä|–∂–∞–ª–æ–±|—Å–Ω–∞–ø—à–æ—Ç|—Å–Ω–∏–º–æ–∫)', re.IGNORECASE),
    # –†–µ–π—Ç–∏–Ω–≥
    re.compile(r'^—Ä–µ–π—Ç–∏–Ω–≥ –ø–æ\s+(?:–≤–∏–¥–µ–æ|–ø—Ä–æ—Å–º–æ—Ç—Ä|–ª–∞–π–∫|–∫–æ–º–º–µ–Ω—Ç–∞—Ä|–∂–∞–ª–æ–±|—Å–Ω–∞–ø—à–æ—Ç)', re.IGNORECASE),
    # üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –≠–ö–°–¢–†–ï–ú–£–ú–´ (–¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–∫–ª–æ–Ω–µ–Ω–∏–π)
    re.compile(r'^(?:–∫—Ç–æ –±–æ–ª—å—à–µ|–∫—Ç–æ –º–µ–Ω—å—à–µ|–º–∞–∫—Å–∏–º—É–º|–º–∏–Ω–∏–º—É–º)\s+(?:–≤–∏–¥–µ–æ|—Ä–æ–ª–∏–∫–æ–≤|–ø—Ä–æ—Å–º–æ—Ç—Ä(?:–æ–≤)?|–ª–∞–π–∫(?:–æ–≤)?|–∫–æ–º–º–µ–Ω—Ç–∞—Ä(?:–∏–µ–≤|–∏–π)?|–∂–∞–ª–æ–±(?:—ã)?|—Å–Ω–∞–ø—à–æ—Ç(?:–æ–≤|—ã)?|—Å–Ω–∏–º–æ–∫(?:–æ–≤|–∏)?|–∫—Ä–µ–∞—Ç–æ—Ä(?:–æ–≤|—ã)?)', re.IGNORECASE),
    # üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –≠–ö–°–¢–†–ï–ú–£–ú (–¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–∫–ª–æ–Ω–µ–Ω–∏–π)
    re.compile(r'^—ç–∫—Å—Ç—Ä–µ–º—É–º\s+(?:–≤–∏–¥–µ–æ|—Ä–æ–ª–∏–∫–æ–≤|–ø—Ä–æ—Å–º–æ—Ç—Ä(?:–æ–≤)?|–ª–∞–π–∫(?:–æ–≤)?|–∫–æ–º–º–µ–Ω—Ç–∞—Ä(?:–∏–µ–≤|–∏–π)?|–∂–∞–ª–æ–±(?:—ã)?|—Å–Ω–∞–ø—à–æ—Ç(?:–æ–≤|—ã)?|—Å–Ω–∏–º–æ–∫(?:–æ–≤|–∏)?|–∫—Ä–µ–∞—Ç–æ—Ä(?:–æ–≤|—ã)?)', re.IGNORECASE),
    # –ë–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ
    re.compile(r'^(?:–±–æ–ª—å—à–µ –≤—Å–µ–≥–æ|–º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ)\s+(?:–≤–∏–¥–µ–æ|–ø—Ä–æ—Å–º–æ—Ç—Ä|–ª–∞–π–∫|–∫–æ–º–º–µ–Ω—Ç–∞—Ä|–∂–∞–ª–æ–±|—Å–Ω–∞–ø—à–æ—Ç)', re.IGNORECASE),
    # –°–∞–º—ã–π –±–æ–ª—å—à–æ–π/–º–∞–ª–µ–Ω—å–∫–∏–π
    re.compile(r'^(?:—Å–∞–º—ã–π –±–æ–ª—å—à–æ–π|—Å–∞–º—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π)\s+(?:–≤–∏–¥–µ–æ|–ø—Ä–æ—Å–º–æ—Ç—Ä|–ª–∞–π–∫|–∫–æ–º–º–µ–Ω—Ç–∞—Ä|–∂–∞–ª–æ–±|—Å–Ω–∞–ø—à–æ—Ç)', re.IGNORECASE),
    # –õ–∏–¥–µ—Ä—ã
    re.compile(r'^–ª–∏–¥–µ—Ä(?:—ã)? –ø–æ\s+(?:–≤–∏–¥–µ–æ|–ø—Ä–æ—Å–º–æ—Ç—Ä|–ª–∞–π–∫|–∫–æ–º–º–µ–Ω—Ç–∞—Ä|–∂–∞–ª–æ–±|—Å–Ω–∞–ø—à–æ—Ç)', re.IGNORECASE),
    # –í–∏–¥–µ–æ –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º
    re.compile(r'–≤–∏–¥–µ–æ\s+(?:–±–æ–ª–µ–µ|–º–µ–Ω–µ–µ|–±–æ–ª—å—à–µ|–º–µ–Ω—å—à–µ)\s*\d+\s*–ø—Ä–æ—Å–º–æ—Ç—Ä', re.IGNORECASE),
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
    re.compile(r'—Å—Ä–∞–≤–Ω–∏\s+\d+\s+–∏\s+\d+', re.IGNORECASE),
    # –í–æ–ø—Ä–æ—Å—ã –ø—Ä–æ "—É –∫–æ–≥–æ"
    re.compile(r'—É –∫–æ–≥–æ (?:–±–æ–ª—å—à–µ –≤—Å–µ–≥–æ|–º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ)', re.IGNORECASE),
    # –ö—Ç–æ –ª—É—á—à–∏–π/—Ö—É–¥—à–∏–π
    re.compile(r'–∫—Ç–æ (?:–ª—É—á—à–∏–π|—Ö—É–¥—à–∏–π|—Å–∏–ª—å–Ω–µ–µ|—Å–ª–∞–±–µ–µ) –ø–æ\s+(?:–≤–∏–¥–µ–æ|–ø—Ä–æ—Å–º–æ—Ç—Ä|–ª–∞–π–∫|–∫–æ–º–º–µ–Ω—Ç–∞—Ä|–∂–∞–ª–æ–±|—Å–Ω–∞–ø—à–æ—Ç)', re.IGNORECASE),
]

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–æ–≤
AI_GENERAL_KEYWORDS = {
    '–æ–±—â–∏–π –∞–Ω–∞–ª–∏–∑', '–∞–Ω–∞–ª–∏–∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã', '–ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑', '–≤—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 'ai –∞–Ω–∞–ª–∏–∑',
    '–∞–Ω–∞–ª–∏–∑ –≤—Å–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã', '–∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ', '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∏–¥–µ–æ', '–ø—Ä–æ—Å–º–æ—Ç—Ä—ã –≤–∏–¥–µ–æ',
    '–≤–∏–¥–µ–æ –∞–Ω–∞–ª–∏–∑', '–∞–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–∏–¥–µ–æ', '–∫–∞–∫–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã —É –≤–∏–¥–µ–æ', '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤',
    # üî• –î–û–ë–ê–í–õ–ï–ù–û:
    '—ç–∫—Å—Ç—Ä–µ–º—É–º',  # —á—Ç–æ–±—ã "—ç–∫—Å—Ç—Ä–µ–º—É–º" —Å–∞–º –ø–æ —Å–µ–±–µ —Ç–æ–∂–µ –æ–ø—Ä–µ–¥–µ–ª—è–ª—Å—è –∫–∞–∫ AI
}

# üî• –ö–õ–Æ–ß–ï–í–´–ï AI –°–õ–û–í–ê –î–õ–Ø –£–ñ–ï–°–¢–û–ß–ï–ù–ò–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–ò
AI_KEYWORD_STARTS = {
    '–∫—Ä–µ–∞—Ç–æ—Ä', '–∞–Ω–∞–ª–∏–∑', '–ø–æ–∫–∞–∂–∏', '–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π', '—Ç–æ–ø', '—Ä–µ–π—Ç–∏–Ω–≥', '—ç–∫—Å—Ç—Ä–µ–º—É–º',
    '–∫—Ç–æ –±–æ–ª—å—à–µ', '–∫—Ç–æ –º–µ–Ω—å—à–µ', '–º–∞–∫—Å–∏–º—É–º', '–º–∏–Ω–∏–º—É–º', '–≤–∏–¥–µ–æ —Å', '—Å—Ä–∞–≤–Ω–∏', '—É –∫–æ–≥–æ',
    '–∫—Ç–æ –ª—É—á—à–∏–π', '–∫—Ç–æ —Ö—É–¥—à–∏–π', '–ª–∏–¥–µ—Ä', '—Å–∞–º—ã–π –±–æ–ª—å—à–æ–π', '—Å–∞–º—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π'
}

# ========== –û–°–¢–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ==========

# –ú—ç–ø–ø–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫
METRIC_CONFIGS = {
    'videos': {'display_name': '–≤–∏–¥–µ–æ', 'emoji': 'üìπ', 'template': "{emoji} –í—Å–µ–≥–æ {metric_name} –≤ —Å–∏—Å—Ç–µ–º–µ: {count:,}", 'method': 'get_total_videos_count'},
    'creators': {'display_name': '–∫—Ä–µ–∞—Ç–æ—Ä–æ–≤', 'emoji': 'üë•', 'template': "{emoji} –í—Å–µ–≥–æ {metric_name} –≤ —Å–∏—Å—Ç–µ–º–µ: {count:,}", 'method': 'get_total_creators_count'},
    'snapshots': {'display_name': '—Å–Ω–∞–ø—à–æ—Ç–æ–≤', 'emoji': 'üì∏', 'template': "{emoji} –í—Å–µ–≥–æ {metric_name} –≤ —Å–∏—Å—Ç–µ–º–µ: {count:,}", 'method': 'get_total_snapshots_count'},
    'reports': {'display_name': '–∂–∞–ª–æ–±', 'emoji': '‚ö†Ô∏è', 'template': "{emoji} –í—Å–µ–≥–æ {metric_name} –≤ —Å–∏—Å—Ç–µ–º–µ: {count:,}", 'method': 'get_total_reports_count'},
    'likes': {'display_name': '–ª–∞–π–∫–æ–≤', 'emoji': '‚ù§Ô∏è', 'template': "{emoji} –í—Å–µ–≥–æ {metric_name} –≤ —Å–∏—Å—Ç–µ–º–µ: {count:,}", 'method': 'get_total_likes_count'},
    'comments': {'display_name': '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤', 'emoji': 'üí¨', 'template': "{emoji} –í—Å–µ–≥–æ {metric_name} –≤ —Å–∏—Å—Ç–µ–º–µ: {count:,}", 'method': 'get_total_comments_count'},
    'views': {'display_name': '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤', 'emoji': 'üëÅÔ∏è', 'template': "{emoji} –í—Å–µ–≥–æ {metric_name} –≤ —Å–∏—Å—Ç–µ–º–µ: {count:,}", 'method': 'get_total_views_count'}
}

# –°–∏–Ω–æ–Ω–∏–º—ã –º–µ—Ç—Ä–∏–∫
METRIC_SYNONYMS = {
    '–≤–∏–¥–µ–æ': 'videos', '—Ä–æ–ª–∏–∫–æ–≤': 'videos', '–≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–æ–≤': 'videos', '—Ä–æ–ª–∏–∫': 'videos', '–≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫': 'videos',
    '–∫—Ä–µ–∞—Ç–æ—Ä–æ–≤': 'creators', '–∞–≤—Ç–æ—Ä–æ–≤': 'creators', '—Å–æ–∑–¥–∞—Ç–µ–ª–µ–π': 'creators', '–∫—Ä–µ–∞—Ç–æ—Ä—ã': 'creators', '–∫—Ä–µ–∞—Ç–æ—Ä': 'creators',
    '—Å–Ω–∞–ø—à–æ—Ç–æ–≤': 'snapshots', '—Å–Ω–∏–º–∫–æ–≤': 'snapshots', '—Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤': 'snapshots', '—Å–Ω–∞–ø—à–æ—Ç—ã': 'snapshots', '—Å–Ω–∞–ø—à–æ—Ç': 'snapshots',
    '–∂–∞–ª–æ–±': 'reports', '—Ä–µ–ø–æ—Ä—Ç–æ–≤': 'reports', '–æ—Ç—á–µ—Ç–æ–≤': 'reports', '–∂–∞–ª–æ–±—ã': 'reports', '–∂–∞–ª–æ–±–∞': 'reports',
    '–ª–∞–π–∫–æ–≤': 'likes', '–Ω—Ä–∞–≤–∏—Ç—Å—è': 'likes', '–ª–∞–π–∫–∏': 'likes', '–ª–∞–π–∫': 'likes',
    '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤': 'comments', '–∫–æ–º–º–µ–Ω—Ç': 'comments', '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏': 'comments', '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': 'comments',
    '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤': 'views', '–ø—Ä–æ—Å–º–æ—Ç—Ä—ã': 'views', '–ø—Ä–æ—Å–º–æ—Ç—Ä': 'views',
}

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–∞—Ç
DATE_KEYWORDS = {
    '—Å–µ–≥–æ–¥–Ω—è', '–≤—á–µ—Ä–∞', '–∑–∞–≤—Ç—Ä–∞', '–Ω–µ–¥–µ–ª—è', '–º–µ—Å—è—Ü', '–≥–æ–¥',
    '—è–Ω–≤–∞—Ä', '—Ñ–µ–≤—Ä–∞–ª', '–º–∞—Ä—Ç', '–∞–ø—Ä–µ–ª', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª',
    '–∞–≤–≥—É—Å—Ç', '—Å–µ–Ω—Ç—è–±—Ä', '–æ–∫—Ç—è–±—Ä', '–Ω–æ—è–±—Ä', '–¥–µ–∫–∞–±—Ä',
}

# –ü–∞—Ç—Ç–µ—Ä–Ω—ã –≤–æ–ø—Ä–æ—Å–æ–≤
QUESTION_PATTERNS = [
    r'—Å–∫–æ–ª—å–∫–æ', r'–∞ —Å–∫–æ–ª—å–∫–æ', r'—Å–∫–∞–∂–∏ —Å–∫–æ–ª—å–∫–æ', r'–ø–æ–¥—Å–∫–∞–∂–∏ —Å–∫–æ–ª—å–∫–æ',
    r'–º–Ω–µ –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å —Å–∫–æ–ª—å–∫–æ', r'–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —Å–∫–æ–ª—å–∫–æ', r'—Ö–æ—á—É –∑–Ω–∞—Ç—å —Å–∫–æ–ª—å–∫–æ',
    r'–ø–æ–∫–∞–∂–∏ —Å–∫–æ–ª—å–∫–æ', r'–Ω–∞–ø–∏—à–∏ —Å–∫–æ–ª—å–∫–æ', r'–≤—ã–≤–µ–¥–∏ —Å–∫–æ–ª—å–∫–æ',
]

QUESTION_REGEXES = [re.compile(pattern, re.IGNORECASE) for pattern in QUESTION_PATTERNS]

# –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã
CONVERSATIONAL_RESPONSES = {
    '–ø—Ä–∏–≤–µ—Ç': "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!\n\n–Ø –º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–±–µ:\n‚Ä¢ –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ –≤ —Å–∏—Å—Ç–µ–º–µ\n‚Ä¢ –°–∫–æ–ª—å–∫–æ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤\n‚Ä¢ –°–∫–æ–ª—å–∫–æ –ª–∞–π–∫–æ–≤ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤\n‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º –∏ –∂–∞–ª–æ–±–∞–º\n\n–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è —á—Ç–æ-–Ω–∏–±—É–¥—å! üòä",
    '–∫–∞–∫ –¥–µ–ª–∞': "ü§ñ –£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –ê —É —Ç–µ–±—è?",
    '—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å': "üìä –Ø —É–º–µ—é –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–∏–¥–µ–æ! –°–ø—Ä–æ—Å–∏ '—Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ?' –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π /help",
    '—Å–ø–∞—Å–∏–±–æ': "üôè –†–∞–¥ –±—ã–ª –ø–æ–º–æ—á—å! –ë—É–¥—É –∂–¥–∞—Ç—å –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤! üòä",
    '–æ—Ç–ª–∏—á–Ω–æ': "üòä –†–∞–¥, —á—Ç–æ –ø–æ–º–æ–≥! –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ!",
    '—Ö–æ—Ä–æ—à–æ': "üòä –û—Ç–ª–∏—á–Ω–æ! –†–∞–¥, —á—Ç–æ —É —Ç–µ–±—è –≤—Å—ë —Ö–æ—Ä–æ—à–æ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
    '—Ç—ã –∫–ª–∞—Å—Å–Ω—ã–π': "ü§ñ –°–ø–∞—Å–∏–±–æ! –¢—ã —Ç–æ–∂–µ –∫–ª–∞—Å—Å–Ω—ã–π! –†–∞–¥ –ø–æ–º–æ–≥–∞—Ç—å —Å –∞–Ω–∞–ª–∏–∑–æ–º –≤–∏–¥–µ–æ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!",
    '—Ç—ã –∫—Ä—É—Ç–æ–π': "ü§ñ –û, —Å–ø–∞—Å–∏–±–æ! –°—Ç–∞—Ä–∞—é—Å—å –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º! –ß—Ç–æ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å?",
    '–º–æ–ª–æ–¥–µ—Ü': "ü§ñ –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ—Ö–≤–∞–ª—É! –ë—É–¥—É –∏ –¥–∞–ª—å—à–µ —Å—Ç–∞—Ä–∞—Ç—å—Å—è!",
    # üî• –î–û–ë–ê–í–õ–ï–ù–û –†–ê–ó–ì–û–í–û–†–ù–´–ï –§–†–ê–ó–´ –° –°–ö–†–ò–ù–®–û–¢–ê:
    '—Ç—ã –º–æ–ª–æ–¥–µ—Ü': "ü§ñ –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ—Ö–≤–∞–ª—É! –ë—É–¥—É –∏ –¥–∞–ª—å—à–µ —Å—Ç–∞—Ä–∞—Ç—å—Å—è! üòä",
    '—Ç—ã –∫–ª–∞—Å—Å–Ω—ã–π': "ü§ñ –°–ø–∞—Å–∏–±–æ! –¢—ã —Ç–æ–∂–µ –∫–ª–∞—Å—Å–Ω—ã–π! –†–∞–¥ –ø–æ–º–æ–≥–∞—Ç—å —Å –∞–Ω–∞–ª–∏–∑–æ–º –≤–∏–¥–µ–æ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏! üëç",
    '—Ç—ã –∫—Ä—É—Ç–æ–π': "ü§ñ –û, —Å–ø–∞—Å–∏–±–æ! –°—Ç–∞—Ä–∞—é—Å—å –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º! –ß—Ç–æ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å? ü§ì",
    '—Ç—ã –∫–ª–µ–≤—ã–π': "ü§ñ –°–ø–∞—Å–∏–±–æ! –ü—Ä–∏—è—Ç–Ω–æ —Å–ª—ã—à–∞—Ç—å! üòÑ –ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?",
    '–∫—Ä—É—Ç–æ': "üòé –°–ø–∞—Å–∏–±–æ! –†–∞–¥, —á—Ç–æ —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è! –•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å —á—Ç–æ-—Ç–æ –µ—â—ë?",
    '–∫–ª–∞—Å—Å–Ω–æ': "üåü –û—Ç–ª–∏—á–Ω–æ! –†–∞–¥, —á—Ç–æ –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω! –ß—Ç–æ –µ—â—ë –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?",
    '—Ç—ã –∫–ª—ë–≤—ã–π': "ü§ñ –°–ø–∞—Å–∏–±–æ! –¢—ã —Ç–æ–∂–µ –∫–ª—ë–≤—ã–π! üòé –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
    # üî• –î–û–ë–ê–í–õ–ï–ù–û –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–û–•–í–ê–õ–´:
    '—É–º–Ω–∏—Ü–∞': "ü§ñ –û–≥–æ, —Å–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç! –°—Ç–∞—Ä–∞—é—Å—å –±—ã—Ç—å —É–º–Ω—ã–º –ø–æ–º–æ—â–Ω–∏–∫–æ–º! üß†",
    '—Ö–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞': "ü§ñ –°–ø–∞—Å–∏–±–æ! –†–∞–¥, —á—Ç–æ —Ä–∞–±–æ—Ç–∞ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è! –ë—É–¥—É –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üí™",
    '–æ—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞': "ü§ñ –ë–æ–ª—å—à–æ–µ —Å–ø–∞—Å–∏–±–æ! –ú–æ—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ –º–∞–∫—Å–∏–º—É–º–µ! üî•",
    '—Å—É–ø–µ—Ä': "üöÄ –°—É–ø–µ—Ä! –°–ø–∞—Å–∏–±–æ! –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤—ã–º –∑–∞–¥–∞—á–∞–º!",
    '–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ': "üòä –ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ —Ç—ã –¥–æ–≤–æ–ª–µ–Ω! –í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å!",
    '–≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ': "‚ú® –í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ —Å–ª—ã—à–∞—Ç—å —Ç–∞–∫–∏–µ —Å–ª–æ–≤–∞! –°–ø–∞—Å–∏–±–æ!",
    # üî• –î–û–ë–ê–í–õ–ï–ù–û –û–ë–©–ò–ï –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ï –†–ï–ê–ö–¶–ò–ò:
    '–∑–¥–æ—Ä–æ–≤–æ': "üëç –ó–¥–æ—Ä–æ–≤–æ! –†–∞–¥, —á—Ç–æ –≤—Å—ë —Ö–æ—Ä–æ—à–æ! –ß—Ç–æ –¥–∞–ª—å—à–µ?",
    '–ø–æ—Ç—Ä—è—Å–∞—é—â–µ': "ü§Ø –ü–æ—Ç—Ä—è—Å–∞—é—â–µ, —á—Ç–æ —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è! –ï—â—ë —á—Ç–æ-–Ω–∏–±—É–¥—å?",
    '–≤–æ—Å—Ö–∏—Ç–∏—Ç–µ–ª—å–Ω–æ': "üòç –í–æ—Å—Ö–∏—Ç–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞! –°–ø–∞—Å–∏–±–æ –±–æ–ª—å—à–æ–µ!",
    # üî• –ù–ï–ô–¢–†–ê–õ–¨–ù–´–ï/–í–û–ü–†–û–°–ò–¢–ï–õ–¨–ù–´–ï:
    '–ø–æ–Ω—è—Ç–Ω–æ': "üëå –ü–æ–Ω—è—Ç–Ω–æ! –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –µ—â—ë –Ω—É–∂–Ω–æ - —Å–ø—Ä–∞—à–∏–≤–∞–π!",
    '—è—Å–Ω–æ': "‚úÖ –Ø—Å–Ω–æ! –ë—É–¥—É –∑–¥–µ—Å—å, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–ª—é—Å—å!",
    '–æ–∫–µ–π': "üëå –û–∫–µ–π! –ß—Ç–æ-—Ç–æ –µ—â—ë?",
    '–ª–∞–¥–Ω–æ': "üëç –õ–∞–¥–Ω–æ! –ù–µ —Å—Ç–µ—Å–Ω—è–π—Å—è —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å!",
    '–∫–ª–µ–≤–æ': "üòä –ö–ª–µ–≤–æ! –†–∞–¥, —á—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è!",
    '–∫–ª—ë–≤–æ': "üòä –°–ø–∞—Å–∏–±–æ! –†–∞–¥, —á—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è!",
    '–∫–ª–∞—Å—Å': "üòé –ö–ª–∞—Å—Å! –°–ø–∞—Å–∏–±–æ!",
}

# ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

def log_debug(msg: str, *args):
    if DEBUG_MODE:
        logger.debug(msg, *args)

def normalize_text(text: str) -> str:
    normalized = text.lower().strip()
    normalized = normalized.rstrip('?!.,;:')
    normalized = re.sub(r'[^\w\s]', ' ', normalized)
    normalized = re.sub(r'\s+', ' ', normalized)
    return normalized.strip()

def extract_command(text: str) -> str:
    if text.startswith('/'):
        parts = text.split()
        return parts[0].lower() if parts else text.lower()
    return ''

def contains_date_keywords(text: str) -> bool:
    normalized = normalize_text(text)
    return any(keyword in normalized for keyword in DATE_KEYWORDS)

#   –§–£–ù–ö–¶–ò–Ø is_ai_command (–í–∞—Ä–∏–∞–Ω—Ç 3)
def is_ai_command(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç AI –∫–æ–º–∞–Ω–¥–æ–π"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã —Å–æ —Å–ª–µ—à–µ–º
    if text.startswith('/'):
        command = extract_command(text)
        
        if command in BASIC_COMMANDS:
            return False
        
        if command in ALL_AI_COMMANDS:
            return True
        
        return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    normalized = normalize_text(text)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–∏—Ñ—Ä—ã 1-19
    if normalized.isdigit():
        try:
            num = int(normalized)
            return 1 <= num <= MAX_AI_CREATOR_ID
        except ValueError:
            pass
    
    #   –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ —Å–ª–æ–≤–∞-–º–µ—Ç—Ä–∏–∫–∏ –ë–ï–ó –≤–æ–ø—Ä–æ—Å–∞
    words = normalized.split()
    if len(words) == 1 and not text.endswith('?'):
        # –ï—Å–ª–∏ —ç—Ç–æ –æ–¥–Ω–æ —Å–ª–æ–≤–æ-–º–µ—Ç—Ä–∏–∫–∞ –ë–ï–ó –≤–æ–ø—Ä–æ—Å–∞ - —ç—Ç–æ –ë–ê–ó–û–í–´–ô –∑–∞–ø—Ä–æ—Å, –Ω–µ AI
        single_word = words[0]
        if single_word in METRIC_SYNONYMS:
            # "–∫—Ä–µ–∞—Ç–æ—Ä—ã" (–±–µ–∑ –≤–æ–ø—Ä–æ—Å–∞) - –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            log_debug(f"‚úÖ –û–¥–∏–Ω–æ—á–Ω–æ–µ —Å–ª–æ–≤–æ '{single_word}' –±–µ–∑ –≤–æ–ø—Ä–æ—Å–∞ - –ë–ê–ó–û–í–´–ô –∑–∞–ø—Ä–æ—Å")
            return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Å AI –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    for ai_word in AI_KEYWORD_STARTS:
        if normalized.startswith(ai_word):
            log_debug(f"üö´ –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å AI —Å–ª–æ–≤–∞ '{ai_word}' - AI –∫–æ–º–∞–Ω–¥–∞")
            return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    for pattern in AI_PATTERNS:
        if pattern.search(normalized):
            log_debug(f"üö´ –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å AI –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º '{pattern.pattern[:30]}...' - AI –∫–æ–º–∞–Ω–¥–∞")
            return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
    if any(keyword in normalized for keyword in AI_GENERAL_KEYWORDS):
        log_debug(f"üö´ –°–æ–¥–µ—Ä–∂–∏—Ç AI –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ - AI –∫–æ–º–∞–Ω–¥–∞")
        return True
    
    return False

#   –§–£–ù–ö–¶–ò–Ø is_basic_stat_query (–í–∞—Ä–∏–∞–Ω—Ç 1)
def is_basic_stat_query(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –±–∞–∑–æ–≤—ã–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–ø—Ä–æ—Å–æ–º"""
    # üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ–º is_ai_command –∑–¥–µ—Å—å - —ç—Ç–æ —É–∂–µ –¥–µ–ª–∞–µ—Ç—Å—è –≤ —Ñ–∏–ª—å—Ç—Ä–µ
    # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∑–∞–ø—Ä–æ—Å –º–µ—Ç—Ä–∏–∫–∏
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—ã
    if contains_date_keywords(text):
        log_debug("üìÖ –ó–∞–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞—Ç—ã - –Ω–µ –±–∞–∑–æ–≤—ã–π")
        return False
    
    normalized = normalize_text(text)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–æ–ø—Ä–æ—Å–æ–≤
    question_found = False
    for pattern in QUESTION_REGEXES:
        if pattern.search(normalized):
            question_found = True
            break
    
    #   –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ —Å–ª–æ–≤–∞-–º–µ—Ç—Ä–∏–∫–∏
    words = normalized.split()
    if len(words) == 1:
        single_word = words[0]
        # –ï—Å–ª–∏ —ç—Ç–æ –æ–¥–Ω–æ —Å–ª–æ–≤–æ-–º–µ—Ç—Ä–∏–∫–∞ - —ç—Ç–æ –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        if single_word in METRIC_SYNONYMS:
            log_debug(f"‚úÖ –û–¥–∏–Ω–æ—á–Ω–æ–µ —Å–ª–æ–≤–æ '{single_word}' - –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å")
            return True
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å - –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –º–µ—Ç—Ä–∏–∫–∏
    if question_found:
        for synonym in METRIC_SYNONYMS:
            if synonym in normalized:
                log_debug(f"‚úÖ –ó–∞–ø—Ä–æ—Å —Å –≤–æ–ø—Ä–æ—Å–æ–º —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç—Ä–∏–∫—É '{synonym}' - –±–∞–∑–æ–≤—ã–π")
                return True
    else:
        # –ï—Å–ª–∏ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–∞, –Ω–æ –µ—Å—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —Å—Ä–µ–¥–∏ —Å–ª–æ–≤
        for word in words:
            if word in METRIC_SYNONYMS:
                # üî• –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å AI —Å–ª–æ–≤–∞, —ç—Ç–æ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ
                # –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç—Ä–∏–∫
                log_debug(f"‚úÖ –°–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç—Ä–∏–∫—É '{word}' - –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å")
                return True
    
    return False

def get_conversational_response(text: str) -> Optional[str]:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö —Ñ—Ä–∞–∑"""
    normalized = normalize_text(text)
    
    # üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—Ä–∞–∑–∞ "–¥–∞–π –º–Ω–µ —Å–ø—Ä–∞–≤–∫—É" —Å –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –∫–∞–∫ –≤ /help
    if normalized in {'—Å–ø—Ä–∞–≤–∫–∞', '–ø–æ–º–æ—â—å', 'help', '—Ö–µ–ª–ø', '–ø–æ–º–æ–≥–∏', '–¥–∞–π —Å–ø—Ä–∞–≤–∫—É', '–¥–∞–π –º–Ω–µ —Å–ø—Ä–∞–≤–∫—É'}: 
        return (
            "üìä **–ë–ê–ó–û–í–´–ï –ö–û–ú–ê–ù–î–´:**\n\n"
            "/stats - –≤—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n"
            "/total_videos - –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ\n"
            "/total_creators - –≤—Å–µ–≥–æ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤\n"
            "/total_snapshots - –≤—Å–µ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–æ–≤\n"
            "/total_reports - –≤—Å–µ–≥–æ –∂–∞–ª–æ–±\n"
            "/total_likes - –≤—Å–µ–≥–æ –ª–∞–π–∫–æ–≤\n"
            "/total_comments - –≤—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤\n"
            "/total_views - –≤—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤\n\n"
            "üí¨ **–¢–ï–ö–°–¢–û–í–´–ï –ó–ê–ü–†–û–°–´:**\n"
            "‚Ä¢ –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ?\n"
            "‚Ä¢ —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤?\n"
            "‚Ä¢ –°–ö–û–õ–¨–ö–û –õ–ê–ô–ö–û–í?\n"
            "‚Ä¢ –°–∫–æ–ª—å–∫–æ —Å–Ω–∞–ø—à–æ—Ç–æ–≤?\n"
            "‚Ä¢ —Å–∫–æ–ª—å–∫–æ –∂–∞–ª–æ–±?\n"
            "‚Ä¢ –°–ö–û–õ–¨–ö–û –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤?\n"
            "‚Ä¢ —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤?\n\n"
            "**–ö–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã:**\n"
            "‚Ä¢ –≤–∏–¥–µ–æ?\n"
            "‚Ä¢ –ª–∞–π–∫–æ–≤?\n"
            "‚Ä¢ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤?\n"
            "‚Ä¢ –∂–∞–ª–æ–±?\n"
            "‚Ä¢ —Å–Ω–∞–ø—à–æ—Ç–æ–≤?\n"
            "‚Ä¢ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤?\n\n"
            "üîÑ **–û–ß–ò–°–¢–ö–ê –ö–≠–®–ê:**\n"
            "/clear_cache - –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à\n"
            "üõ†Ô∏è **–ü–†–û–í–ï–†–ö–ê –ë–î:**\n"
            "/test_db - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n\n"
            "ü§ñ **AI –ê–ù–ê–õ–ò–¢–ò–ö–ê:**\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ai_help –¥–ª—è AI –∫–æ–º–∞–Ω–¥"
        )

    #   –ü–†–Ø–ú–û–ï –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –ò–ó –°–õ–û–í–ê–†–Ø
    if normalized in CONVERSATIONAL_RESPONSES:
        return CONVERSATIONAL_RESPONSES[normalized]
    
    #   –ü–ê–¢–¢–ï–†–ù–´ –î–õ–Ø –ü–û–•–í–ê–õ (–¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞—Ü–∏–π)
    praise_patterns = [
        ('—Ç—ã –º–æ–ª–æ–¥–µ—Ü', "ü§ñ –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ—Ö–≤–∞–ª—É! –ë—É–¥—É –∏ –¥–∞–ª—å—à–µ —Å—Ç–∞—Ä–∞—Ç—å—Å—è! üòä"),
        ('—Ç—ã –∫–ª–∞—Å—Å–Ω—ã–π', "ü§ñ –°–ø–∞—Å–∏–±–æ! –¢—ã —Ç–æ–∂–µ –∫–ª–∞—Å—Å–Ω—ã–π! –†–∞–¥ –ø–æ–º–æ–≥–∞—Ç—å —Å –∞–Ω–∞–ª–∏–∑–æ–º –≤–∏–¥–µ–æ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏! üëç"),
        ('—Ç—ã –∫—Ä—É—Ç–æ–π', "ü§ñ –û, —Å–ø–∞—Å–∏–±–æ! –°—Ç–∞—Ä–∞—é—Å—å –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º! –ß—Ç–æ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å? ü§ì"),
        ('—Ç—ã –∫–ª–µ–≤—ã–π', "ü§ñ –°–ø–∞—Å–∏–±–æ! –ü—Ä–∏—è—Ç–Ω–æ —Å–ª—ã—à–∞—Ç—å! üòÑ –ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?"),
        ('—Ç—ã –∫–ª—ë–≤—ã–π', "ü§ñ –°–ø–∞—Å–∏–±–æ! –¢—ã —Ç–æ–∂–µ –∫–ª—ë–≤—ã–π! üòé –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"),
        ('–º–æ–ª–æ–¥–µ—Ü', "ü§ñ –°–ø–∞—Å–∏–±–æ! –°—Ç–∞—Ä–∞—é—Å—å! üòä"),
        ('–∫–ª–∞—Å—Å–Ω—ã–π', "ü§ñ –°–ø–∞—Å–∏–±–æ! üòé"),
        ('–∫—Ä—É—Ç–æ–π', "ü§ñ –û, —Å–ø–∞—Å–∏–±–æ! üëç"),
        ('–∫–ª–µ–≤–æ', "üòä –ö–ª–µ–≤–æ! –†–∞–¥, —á—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è!"),
        ('–∫–ª—ë–≤–æ', "üòä –°–ø–∞—Å–∏–±–æ! –†–∞–¥, —á—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è!"),
        ('–∫–ª–∞—Å—Å', "üòé –ö–ª–∞—Å—Å! –°–ø–∞—Å–∏–±–æ!"),
    ]
    
    for pattern, response in praise_patterns:
        if pattern in normalized:
            return response
    
    #   –û–ë–©–ò–ï –†–ê–ó–ì–û–í–û–†–ù–´–ï –ü–ê–¢–¢–ï–†–ù–´
    conversational_patterns = [
        '–∫–∞–∫ –¥–µ–ª', '–∫–∞–∫ —Ç—ã', '–∫–∞–∫ —É —Ç–µ–±—è', '–∫–∞–∫ —Ç–≤–æ–∏', '–∫–∞–∫ –∂–∏–∑–Ω—å',
        '—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å', '—á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å', '–∫—Ç–æ —Ç—ã',
        '—Å–ø–∞—Å–∏–±–æ', '–±–ª–∞–≥–æ–¥–∞—Ä—é', '–ø–∞—Å–∏–±'
    ]
    
    for pattern in conversational_patterns:
        if pattern in normalized:
            if '–∫–∞–∫' in pattern:
                return "ü§ñ –£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –ê —É —Ç–µ–±—è?"
            elif '—á—Ç–æ' in pattern or '–∫—Ç–æ' in pattern:
                return "üìä –Ø –±–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏! –°–ø—Ä–æ—Å–∏ '—Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ?' –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π /help"
            elif '—Å–ø–∞—Å–∏–±–æ' in pattern:
                return "üôè –†–∞–¥ –±—ã–ª –ø–æ–º–æ—á—å! –ë—É–¥—É –∂–¥–∞—Ç—å –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤! üòä"
    
    return None

async def get_metric_stat(metric_key: str) -> Optional[tuple]:
    if metric_key not in METRIC_CONFIGS:
        logger.warning(f"‚ùå –ö–ª—é—á {metric_key} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ METRIC_CONFIGS")
        return None
    
    config = METRIC_CONFIGS[metric_key]
    method_name = config['method']
    
    if not hasattr(db_manager, method_name):
        logger.error(f"‚ùå –ú–µ—Ç–æ–¥ {method_name} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ db_manager!")
        return None
    
    try:
        method = getattr(db_manager, method_name)
        count = await method()
        if count is None:
            count = 0
            logger.warning(f"‚ö†Ô∏è –ú–µ—Ç–æ–¥ {method_name} –≤–µ—Ä–Ω—É–ª None, –∏—Å–ø–æ–ª—å–∑—É–µ–º 0")
        return count, config
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è {metric_key}: {e}")
        logger.error(traceback.format_exc())
        return None

async def handle_metric_query(text: str, message: Message) -> bool:
    normalized = normalize_text(text)
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã —Å –¥–∞—Ç–∞–º–∏
    if contains_date_keywords(text):
        return False
    
    # üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Å–ª–æ–≤
    words = normalized.split()
    if len(words) == 1:
        if words[0] in METRIC_SYNONYMS:
            canonical_metric = METRIC_SYNONYMS[words[0]]
            result = await get_metric_stat(canonical_metric)
            
            if result:
                count, config = result
                # –î–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Å–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                if words[0] == '–∫—Ä–µ–∞—Ç–æ—Ä—ã' or words[0] == '–∫—Ä–µ–∞—Ç–æ—Ä':
                    display_name = '–∫—Ä–µ–∞—Ç–æ—Ä–æ–≤'
                elif words[0] == '–ª–∞–π–∫–∏' or words[0] == '–ª–∞–π–∫':
                    display_name = '–ª–∞–π–∫–æ–≤'
                elif words[0] == '–ø—Ä–æ—Å–º–æ—Ç—Ä—ã' or words[0] == '–ø—Ä–æ—Å–º–æ—Ç—Ä':
                    display_name = '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤'
                elif words[0] == '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏' or words[0] == '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π':
                    display_name = '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤'
                elif words[0] == '–∂–∞–ª–æ–±—ã' or words[0] == '–∂–∞–ª–æ–±–∞':
                    display_name = '–∂–∞–ª–æ–±'
                elif words[0] == '—Å–Ω–∞–ø—à–æ—Ç—ã' or words[0] == '—Å–Ω–∞–ø—à–æ—Ç':
                    display_name = '—Å–Ω–∞–ø—à–æ—Ç–æ–≤'
                elif words[0] == '–≤–∏–¥–µ–æ' or words[0] == '—Ä–æ–ª–∏–∫':
                    display_name = '–≤–∏–¥–µ–æ'
                else:
                    display_name = config['display_name']
                
                template = config['template'].replace('{metric_name}', display_name)
                response = template.format(emoji=config['emoji'], count=count)
                await message.answer(response)
                return True
    
    # –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤
    if len(words) <= 2:
        for word in words:
            if word in METRIC_SYNONYMS:
                canonical_metric = METRIC_SYNONYMS[word]
                result = await get_metric_stat(canonical_metric)
                
                if result:
                    count, config = result
                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    if word == '–∫—Ä–µ–∞—Ç–æ—Ä—ã' or word == '–∫—Ä–µ–∞—Ç–æ—Ä':
                        display_name = '–∫—Ä–µ–∞—Ç–æ—Ä–æ–≤'
                    elif word == '–ª–∞–π–∫–∏' or word == '–ª–∞–π–∫':
                        display_name = '–ª–∞–π–∫–æ–≤'
                    elif word == '–ø—Ä–æ—Å–º–æ—Ç—Ä—ã' or word == '–ø—Ä–æ—Å–º–æ—Ç—Ä':
                        display_name = '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤'
                    elif word == '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏' or word == '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π':
                        display_name = '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤'
                    elif word == '–∂–∞–ª–æ–±—ã' or word == '–∂–∞–ª–æ–±–∞':
                        display_name = '–∂–∞–ª–æ–±'
                    elif word == '—Å–Ω–∞–ø—à–æ—Ç—ã' or word == '—Å–Ω–∞–ø—à–æ—Ç':
                        display_name = '—Å–Ω–∞–ø—à–æ—Ç–æ–≤'
                    elif word == '–≤–∏–¥–µ–æ' or word == '—Ä–æ–ª–∏–∫':
                        display_name = '–≤–∏–¥–µ–æ'
                    else:
                        display_name = config['display_name']
                    
                    template = config['template'].replace('{metric_name}', display_name)
                    response = template.format(emoji=config['emoji'], count=count)
                    await message.answer(response)
                    return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç—Ä–∏–∫ –≤ —Ç–µ–∫—Å—Ç–µ
    found_metrics = []
    for synonym, canonical in METRIC_SYNONYMS.items():
        if synonym in normalized:
            found_metrics.append(canonical)
    
    found_metrics = list(set(found_metrics))
    
    if not found_metrics:
        return False
    
    metric_key = found_metrics[0]
    result = await get_metric_stat(metric_key)
    
    if result:
        count, config = result
        display_name = config['display_name']
        template = config['template'].replace('{metric_name}', display_name)
        response = template.format(emoji=config['emoji'], count=count)
        await message.answer(response)
        return True
    
    return False

# ========== –ö–ê–°–¢–û–ú–ù–´–ô –§–ò–õ–¨–¢–† ==========

class BasicCommandFilter(Filter):
    """–§–∏–ª—å—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π –ª–æ–≤–∏—Ç –¢–û–õ–¨–ö–û –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∑–∞–ø—Ä–æ—Å—ã"""
    
    async def __call__(self, message: Message) -> bool:
        text = message.text.strip() if message.text else ""
        logger.info(f"üîç BasicFilter –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ: '{text}'")
        
        if not text:
            return False
        
        # –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Å–æ —Å–ª–µ—à–µ–º –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if text.startswith('/'):
            logger.info(f"üö´ BasicFilter: –∫–æ–º–∞–Ω–¥–∞ —Å–æ —Å–ª–µ—à–µ–º '{text}' - –ü–†–û–ü–£–°–ö–ê–ï–ú")
            return False
        
        #   –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ AI –ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å
        if is_ai_command(text):
            logger.info(f"üö´ BasicFilter: '{text}' - —ç—Ç–æ AI –∑–∞–ø—Ä–æ—Å (—Ç–µ–∫—Å—Ç–æ–≤—ã–π)")
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—ã–π —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
        if is_basic_stat_query(text):
            logger.info(f"‚úÖ BasicFilter: '{text}' - –±–∞–∑–æ–≤—ã–π —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å")
            return True
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
        normalized = normalize_text(text)
        words = normalized.split()
        
        for word in words:
            if word in METRIC_SYNONYMS:
                logger.info(f"‚úÖ BasicFilter: —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç—Ä–∏–∫—É '{word}'")
                return True
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã
        if get_conversational_response(text) is not None:
            logger.info("‚úÖ BasicFilter: —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–∞—è —Ñ—Ä–∞–∑–∞")
            return True
        
        logger.info("‚ùå BasicFilter: –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º")
        return False

# ========== –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ ==========

@router.message(Command("start"))
async def cmd_start(message: Message):
    logger.info("üé¨ –í—ã–∑–≤–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /start")
    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –±–∞–∑–æ–≤–æ–π –≤–∏–¥–µ–æ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.\n\n"
        "üìä **–û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´:**\n"
        "/stats - –≤—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—Ä–∞–∑—É\n"
        "/total_videos - —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ\n"
        "/total_creators - —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤\n"
        "/total_snapshots - —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–æ–≤\n"
        "/total_reports - —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∂–∞–ª–æ–±\n"
        "/total_likes - —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –ª–∞–π–∫–æ–≤\n"
        "/total_comments - —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤\n"
        "/total_views - —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤\n\n"
        "üí° **–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Ç–µ:**\n"
        "‚Ä¢ '–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ?'\n"
        "‚Ä¢ '—Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –ª–∞–π–∫–æ–≤?'\n"
        "‚Ä¢ '–°–ö–û–õ–¨–ö–û –ö–†–ï–ê–¢–û–†–û–í?'\n"
        "‚Ä¢ '—Å–∫–æ–ª—å–∫–æ —Å–Ω–∞–ø—à–æ—Ç–æ–≤?'\n"
        "‚Ä¢ '–ü–æ–¥—Å–∫–∞–∂–∏ —Å–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ'\n"
        "‚Ä¢ '–ê —Å–∫–æ–ª—å–∫–æ –ª–∞–π–∫–æ–≤?'\n"
        "‚Ä¢ '–≤–∏–¥–µ–æ?'\n"
        "‚Ä¢ '–ª–∞–π–∫–æ–≤?'\n"
        "‚Ä¢ '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤?'\n\n"
        "‚ùì **–ü–æ–º–æ—â—å:** /help - –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥"
    )

@router.message(Command("help"))
async def cmd_help(message: Message):
    logger.info("üé¨ –í—ã–∑–≤–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /help")
    await message.answer(
        "üìä **–ë–ê–ó–û–í–´–ï –ö–û–ú–ê–ù–î–´:**\n\n"
        "/stats - –≤—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n"
        "/total_videos - –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ\n"
        "/total_creators - –≤—Å–µ–≥–æ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤\n"
        "/total_snapshots - –≤—Å–µ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–æ–≤\n"
        "/total_reports - –≤—Å–µ–≥–æ –∂–∞–ª–æ–±\n"
        "/total_likes - –≤—Å–µ–≥–æ –ª–∞–π–∫–æ–≤\n"
        "/total_comments - –≤—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤\n"
        "/total_views - –≤—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤\n\n"
        "üí¨ **–¢–ï–ö–°–¢–û–í–´–ï –ó–ê–ü–†–û–°–´:**\n"
        "‚Ä¢ –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ?\n"
        "‚Ä¢ —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤?\n"
        "‚Ä¢ –°–ö–û–õ–¨–ö–û –õ–ê–ô–ö–û–í?\n"
        "‚Ä¢ –°–∫–æ–ª—å–∫–æ —Å–Ω–∞–ø—à–æ—Ç–æ–≤?\n"
        "‚Ä¢ —Å–∫–æ–ª—å–∫–æ –∂–∞–ª–æ–±?\n"
        "‚Ä¢ –°–ö–û–õ–¨–ö–û –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤?\n"
        "‚Ä¢ —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤?\n\n"
        "**–ö–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã:**\n"
        "‚Ä¢ –≤–∏–¥–µ–æ?\n"
        "‚Ä¢ –ª–∞–π–∫–æ–≤?\n"
        "‚Ä¢ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤?\n"
        "‚Ä¢ –∂–∞–ª–æ–±?\n"
        "‚Ä¢ —Å–Ω–∞–ø—à–æ—Ç–æ–≤?\n"
        "‚Ä¢ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤?\n\n"
        "üîÑ **–û–ß–ò–°–¢–ö–ê –ö–≠–®–ê:**\n"
        "/clear_cache - –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à\n"
        "üõ†Ô∏è **–ü–†–û–í–ï–†–ö–ê –ë–î:**\n"
        "/test_db - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n\n"
        "ü§ñ **AI –ê–ù–ê–õ–ò–¢–ò–ö–ê:**\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ai_help –¥–ª—è AI –∫–æ–º–∞–Ω–¥"
    )

@router.message(Command("stats"))
async def cmd_stats(message: Message):
    logger.info("üé¨ –í—ã–∑–≤–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /stats")
    try:
        stats = await db_manager.get_all_basic_stats()
        
        response = (
            "üìä **–ü–û–õ–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:**\n\n"
            f"üìπ –í—Å–µ–≥–æ –≤–∏–¥–µ–æ: {stats.get('total_videos', 0):,}\n"
            f"üë• –í—Å–µ–≥–æ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤: {stats.get('total_creators', 0):,}\n"
            f"üì∏ –í—Å–µ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–æ–≤: {stats.get('total_snapshots', 0):,}\n"
            f"üëÅÔ∏è –í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {stats.get('total_views', 0):,}\n"
            f"‚ù§Ô∏è –í—Å–µ–≥–æ –ª–∞–π–∫–æ–≤: {stats.get('total_likes', 0):,}\n"
            f"üí¨ –í—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: {stats.get('total_comments', 0):,}\n"
            f"‚ö†Ô∏è –í—Å–µ–≥–æ –∂–∞–ª–æ–±: {stats.get('total_reports', 0):,}"
        )
        
        await message.answer(response)
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ cmd_stats: {e}")
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
def create_metric_handler(metric_key: str):
    async def handler(message: Message):
        logger.info(f"üé¨ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ /total_{metric_key} –í–´–ó–í–ê–ù!")
        try:
            result = await get_metric_stat(metric_key)
            if result:
                count, config = result
                logger.info(f"‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –¥–ª—è {metric_key}: {count}")
                display_name = config['display_name']
                template = config['template'].replace('{metric_name}', display_name)
                response = template.format(emoji=config['emoji'], count=count)
                await message.answer(response)
            else:
                logger.warning(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è {metric_key}")
                await message.answer(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è {config['display_name']}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ {metric_key}: {e}")
            await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
    return handler

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏
logger.info("üìù –ù–∞—á–∏–Ω–∞—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
for metric_key, config in METRIC_CONFIGS.items():
    command_name = f"total_{metric_key}"
    handler = create_metric_handler(metric_key)
    router.message(Command(command_name))(handler)
    logger.info(f"‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è: /{command_name}")

@router.message(Command("clear_cache"))
async def cmd_clear_cache(message: Message):
    logger.info("üé¨ –í—ã–∑–≤–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /clear_cache")
    try:
        await db_manager.clear_cache()
        await message.answer("‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω!")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ cmd_clear_cache: {e}")
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

@router.message(Command("test_db"))
async def cmd_test_db(message: Message):
    logger.info("üé¨ –í—ã–∑–≤–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /test_db")
    try:
        if await db_manager.test_connection():
            await message.answer("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")
        else:
            await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ cmd_test_db: {e}")
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

# ========== –û–ë–†–ê–ë–û–¢–ö–ê –¢–ï–ö–°–¢–û–í–´–• –ó–ê–ü–†–û–°–û–í ==========

@router.message(BasicCommandFilter())
async def handle_text_query(message: Message):
    text = message.text.strip()
    
    if not text:
        return
    
    logger.info(f"üì® BasicHandler –ø–æ–ª—É—á–∏–ª –∑–∞–ø—Ä–æ—Å: '{text}'")
    
    conversational_response = get_conversational_response(text)
    
    if conversational_response:
        logger.info(f"üí¨ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∫–∞–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—É—é —Ñ—Ä–∞–∑—É: '{text}'")
        await message.answer(conversational_response)
        return
    
    handled = await handle_metric_query(text, message)
    if handled:
        logger.info(f"üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω –∫–∞–∫ –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: '{text}'")
        return
    
    logger.info(f"ü§î –ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∑–∞–ø—Ä–æ—Å: '{text}'")
    help_text = (
        "ü§î –Ø –ø–æ–Ω–∏–º–∞—é –∑–∞–ø—Ä–æ—Å—ã –≤–∏–¥–∞:\n\n"
        "‚Ä¢ –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ?\n"
        "‚Ä¢ —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤?\n"
        "‚Ä¢ –°–ö–û–õ–¨–ö–û –í–°–ï–ì–û –õ–ê–ô–ö–û–í?\n"
        "‚Ä¢ –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–æ–≤?\n\n"
        "**–ò–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ:**\n"
        "‚Ä¢ –≤–∏–¥–µ–æ?\n"
        "‚Ä¢ –ª–∞–π–∫–æ–≤?\n"
        "‚Ä¢ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤?\n"
        "‚Ä¢ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤?\n"
        "‚Ä¢ –∂–∞–ª–æ–±?\n"
        "‚Ä¢ —Å–Ω–∞–ø—à–æ—Ç–æ–≤?\n"
        "‚Ä¢ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤?\n\n"
        "**–ò–ª–∏ –¥—Ä—É–≥–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏:**\n"
        "‚Ä¢ –ü–æ–¥—Å–∫–∞–∂–∏ —Å–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ\n"
        "‚Ä¢ –ê —Å–∫–æ–ª—å–∫–æ –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤?\n"
        "‚Ä¢ –ú–Ω–µ –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å —Å–∫–æ–ª—å–∫–æ –ª–∞–π–∫–æ–≤\n\n"
        "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ /help"
    )
    
    await message.answer(help_text)

# ========== –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ==========

logger.info("‚úÖ –ú–æ–¥—É–ª—å base_handlers –∑–∞–≥—Ä—É–∂–µ–Ω")
logger.info(f"üìä –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –º–µ—Ç—Ä–∏–∫: {len(METRIC_CONFIGS)}")
logger.info(f"üìã BASIC_COMMANDS: {', '.join(sorted(BASIC_COMMANDS))}")